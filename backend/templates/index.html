<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rayfall Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #171c3a;
      color: rgb(226, 220, 220);
    }

    h1, h2, h3, label, p {
      color: rgb(226, 220, 220);
    }

    .header-container {
      display: flex;
      background-color: #171c3a;
      padding: 10px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      width: 220px;
    }

    .logo-section img {
      height: 75px;
      margin-right: 10px;
    }

    .logo-section h1 {
      margin: 0;
      font-size: 2rem;
    }

    .controls-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-left: 20px;
    }

    .control-row, .filter-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .control-row input[type="date"],
    .control-row button,
    .control-row select {
      background-color: #2c2f5e;
      color: rgb(226, 220, 220);
      border: 1px solid #444;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .control-row button,
    .control-row select {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .control-row button:hover,
    .control-row select:hover {
      background-color: #3a4177;
    }

    .lines-toggle {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .compact-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .color-dot {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }

    #map {
      height: calc(100vh - 160px);
      width: 100%;
    }

    .leaflet-control {
      background-color: #1e234d !important;
      color: rgb(226, 220, 220) !important;
      border: none;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <div class="logo-section">
      <img src="/static/rayfall.png" alt="Rayfall Logo" />
      <h1>Rayfall</h1>
    </div>
    <div class="controls-section">
      <div class="control-row">
        <label for="start">Start:</label>
        <input type="date" id="start" />
        <label for="end">End:</label>
        <input type="date" id="end" />
        <button onclick="loadQSOs()">Load QSOs</button>
        <label class="lines-toggle">
          <input type="checkbox" id="showLines" onchange="toggleLines()" /> Show Lines
        </label>
        <label>
          <input type="checkbox" id="colorByBand" checked onchange="filterQSOs()" /> Color by Band
        </label>
        <label>
          <select id="basemapSelector" onchange="switchBaseMap(this.value)">
            <option value="light">Light</option>
            <option value="dark" selected>Dark</option>
            <option value="topo">Topographic</option>
            <option value="satellite">Satellite</option>
            <option value="streets">Streets</option>
          </select>
        </label>
      </div>
      <div class="filter-row">
        <div><strong>QSOs shown: <span id="qsoCount">0</span></strong></div>
        <div><strong>Bands:</strong></div>
        <div id="bandFilters" class="compact-filters"></div>
        <div><strong>Modes:</strong></div>
        <div id="modeFilters" class="compact-filters"></div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([39.0374, -77.408967], 4);
    let markers = [];
    let lines = [];
    let currentQSOs = [];
    let bandColors = {
        "6m": "#FA0F0F",
        "10m": "#FF4C4C",
        "15m": "#D2B48C",
        "17m": "#FFFF99",
        "20m": "#FFC300",
        "30m": "#00CC66",
        "40m": "#3399FF",
        "80m": "#800080",
        "160m": "#6AFF4C"
    };

    let baseLayers = {
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
            maxZoom: 19
        }),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
            maxZoom: 19
        }),
        topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
            maxZoom: 17
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a> &mdash; Source: Esri, i-cubed, USDA, USGS',
            maxZoom: 19
        }),
        streets: L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 20
        })
        };

    baseLayers.dark.addTo(map);

    function switchBaseMap(key) {
      Object.values(baseLayers).forEach(layer => map.removeLayer(layer));
      baseLayers[key].addTo(map);
    }

    let qthMarker = L.marker([39.0374, -77.408967], {
      icon: L.divIcon({ className: 'custom-qth-icon', html: '⭐', iconSize: [20, 20] })
    }).addTo(map);

    function loadQSOs() {
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      if (!start || !end) return alert("Please select a start and end date.");

      fetch(`/api/logs?start=${start}&end=${end}`)
        .then(response => response.json())
        .then(data => {
          clearMap();
          populateFilters(data.qsos);
          plotQSOs(data.qsos);
        });
    }

    function clearMap() {
      markers.forEach(m => map.removeLayer(m));
      lines.forEach(l => map.removeLayer(l));
      markers = [];
      lines = [];
    }

    function populateFilters(qsos) {
      const bandSet = new Set();
      const modeSet = new Set();
      currentQSOs = qsos;

      qsos.forEach(q => {
        if (q.band) bandSet.add(q.band);
        if (q.mode) modeSet.add(q.mode);
      });

      const bandFilters = document.getElementById("bandFilters");
      bandFilters.innerHTML = "";
      bandSet.forEach(band => {
        const color = bandColors[band] || "#999";
        const label = document.createElement("label");
        label.innerHTML = `<span class="color-dot" style="background-color:${color}"></span><input type="checkbox" checked value="${band}" onchange="filterQSOs()"> ${band}`;
        bandFilters.appendChild(label);
      });

      const modeFilters = document.getElementById("modeFilters");
      modeFilters.innerHTML = "";
      modeSet.forEach(mode => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" checked value="${mode}" onchange="filterQSOs()"> ${mode}`;
        modeFilters.appendChild(label);
      });
    }

    function plotQSOs(qsos) {
      document.getElementById("qsoCount").textContent = qsos.length;
      qsos.forEach(qso => {
        if (!qso.lat || !qso.lon) return;

        const useBandColor = document.getElementById("colorByBand").checked;
        const markerColor = useBandColor ? (bandColors[qso.band] || "#000") : "#3399FF";

        const svgIcon = L.divIcon({
          className: "",
          html: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="36" viewBox="0 0 24 36">
            <path d="M12 0C5.4 0 0 5.4 0 12c0 7.5 12 24 12 24s12-16.5 12-24C24 5.4 18.6 0 12 0z" fill="${markerColor}" stroke="#000" stroke-width="1"/>
            <circle cx="12" cy="12" r="5" fill="#fff"/></svg>`,
          iconSize: [24, 36],
          iconAnchor: [12, 36],
          popupAnchor: [0, -36]
        });

        const marker = L.marker([qso.lat, qso.lon], { icon: svgIcon })
          .bindPopup(`<b>${qso.call}</b><br>${qso.band}, ${qso.mode}<br>${qso.qso_date} ${qso.time_on}`);

        marker.qso = qso;

        marker.addTo(map);
        markers.push(marker);

        if (document.getElementById("showLines").checked && qso.lat && qso.lon) {
            const outline = L.polyline([
            [qso.my_lat, qso.my_lon],
            [qso.lat, qso.lon]
            ], {
            color: "grey",
            weight: 2,
            opacity: 1
            }).addTo(map);

            lines.push(outline);
        }
      });
    }

    function filterQSOs() {
      const selectedBands = Array.from(document.querySelectorAll("#bandFilters input:checked")).map(cb => cb.value);
      const selectedModes = Array.from(document.querySelectorAll("#modeFilters input:checked")).map(cb => cb.value);
      const filtered = currentQSOs.filter(q => selectedBands.includes(q.band) && selectedModes.includes(q.mode));
      clearMap();
      plotQSOs(filtered);
    }

    function toggleLines() {
      filterQSOs();
    }
  </script>
</body>
</html>
